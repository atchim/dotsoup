#!/bin/bash

MY_HELP="launch-bar
launch a Polybar bar

USAGE
  launch-bar [--] [-h] <bar>

FLAGS
      --      treat next arguments as positional arguments
  -h  --help  print help information and exit

POSITIONAL ARGUMENTS
  <bar>  name of the bar to launch"

bar() { [[ $MY_BAR ]] && die "invalid trailing argument: $1"; MY_BAR="$1"; }
die() { (($#)) && err "$@"; exit 1; }
err() { echo "launch-bar: ERROR: $@" >&2; }

parse() {
  while (($#)); do
    ((MY_RAW)) && { bar "$1"; shift 1; continue; }
    case $1 in
      --) MY_RAW=1 ;;
      -h|--help) echo "$MY_HELP"; exit ;;
      -*) die "invalid option: $1" >&2 ;;
      *) bar "$1" ;;
    esac
    shift 1
  done
  [[ $MY_BAR ]] || die "<bar> not given"
}

run() {
  parse "$@"
  local file="${XDG_CONFIG_HOME:-$HOME/.config}/polybar/$MY_BAR.ini"
  [[ -f $file ]] || die "bar file doesn't exist: $file"
  local tmp=/tmp/polybar-$USER-$MY_BAR
  [[ -p $tmp ]] && kill $(readlink $tmp | cut -d. -f2)
  polybar -c "$file" "$MY_BAR" &
  ln -fs /tmp/polybar_mqueue.$! "$tmp"
}

run "$@"
